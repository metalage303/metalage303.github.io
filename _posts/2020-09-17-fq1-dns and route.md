---
layout: post
title: LET'S FQ1 - DNS污染的原理以及应对策略（基础）
description: 
summary: Options to learn to code online.
tags: [GFW]
---

#### 1、缘起

欢迎访问我的博客，原本这篇文章的初衷只是记录一下在Centos下进行智能路由的一些操作，但没想到这个记录越来越长，越来越庞大，那么索性干脆写个“翻墙教程”吧。教程的大多数内容都是从浩瀚的网络中借鉴而来的，我仅仅是做了一个整理收集的工作。目前，网上关于翻墙的文章结构都比较分散，往往是一个标题只涉及一个知识点，没有系统性的整合。鉴于此，本教程力求做到涵盖翻墙的每一个技术细节，章节按照性质不同，大致分成两大类：其中标题含有【教程】关键字的以知识点讲解为主，包含【操作】关键字的则不谈原理，只讲实操。

----

#### 2、DNS以及DNS污染的成因（dnscrypt-proxy + dnsmasq方案）

首先，互联网上的主机之间通讯依靠的是数字IP地址，但人类对这种毫无意义的纯数字的IP很不感冒，因为太难记了，于是就有了由字母组成，具有一定意义的域名，比如qq.com，现在问题来了，人类能懂的域名机器不懂，机器懂的数字IP人类又记不住，那就需要一个媒介将两者的绑定关系连接起来，这个媒介就叫做DNS服务器。

当我们在浏览器输入qq.com的时候，第一步并不会立刻和腾讯服务器连接上，而是先询问DNS服务器（请注意，所有的DNS服务器自身一定是以数字IP示人），请告诉我qq.com的IP地址是多少，DNS服务器回答：125.39.52.26，于是我们得到了qq.com的IP地址，然后才能开始正常访问。

以上，是大部分“正常国家”的互联网访问模式，但别忘了我们是有中国特色的社会主义国家，注定有些地方会比较有“特色”，这就是所谓的GFW. 而域名污染则是GFW其中的一个重要功能之一，那什么又是域名污染呢？很简单，当我们在浏览器输入google.com的时候，这个字符串会传递到你的宽带服务商为你指定的默认DNS服务器里，然后查询对应的IP，GFW在这一步做了手脚，因为本来就不想让你访问google，那么它会返回一个虚假的google.com的地址，导致你的浏览器无法正常与google服务器连接。

![](https://github.com/rockage/rockage.github.io/blob/master/_posts/images/dns-01.png?raw=true)

那么你可能会说，听说DNS服务器是可以设置的，那我不用宽带商提供给我的默认DNS服务器，而是自己设一台可信的DNS服务器不就得了，比如google公司本身也提供DNS服务，其服务器地址是8.8.8.8，那我在Windows的网卡设置里将DNS服务器设为8.8.8.8不就万事大吉了？ 没错，曾经有一段时间这个想法还真可行，但是很快8.8.8.8这个IP就被GFW封锁了，导致无法为你正常提供DNS服务。再后来，GFW想出了一个更牛逼的方法，那就是弄一台假的8.8.8.8！你以为你获得了真实的、可信赖的DNS服务了？那你还是图样图森破了，这些假的域名服务器会为你返回各种各样稀奇古怪的IP地址，让你根本无法访问那些GFW不想让你接触的网站。

那咱们的方案又是如何做到防止域名污染的呢？

----

#### 3、dnscrypt-proxy 与 dnsmasq

首先是摒弃掉宽带服务器给你的默认DNS服务器，而是自己建一台（实际是两台，下文会有详述），这是基础中的基础。

![](https://github.com/rockage/rockage.github.io/blob/master/_posts/images/dns-02.png?raw=true)

dnscrypt-proxy是什么？首先它是一个搭建DNS服务器的程序，但也并非一个程序这么简单，它还是一个为了防止域名污染公益项目，由OpenDNS主导（思科公司的子公司），其在全球部署了许多可靠的DNS服务器。传统DNS服务器走的是明文通道，这意味着任何人略施小计都能知道你在浏览什么网站，而dnscrypt走的是加密通道，浏览安全性大大提高。当我们向dnscrypt的DNS服务器通过加密方式查询一个域名对应的IP时，有两个优势，首先是数据很安全，其他人并不知道我在浏览哪个网站，其次，dnscrypt返回的IP可以认为是可靠的真实IP，而不是杜撰出来的虚假IP。

![](https://github.com/rockage/rockage.github.io/blob/master/_posts/images/dns-03.png?raw=true)

那么dnsmasq又是什么呢？它也是一个搭建DNS服务器的程序，通过简单的设置，不仅可以用来搭建DNS服务器，也可以用来搭建DHCP服务器。那么你可能会问，既然dnscrypt这么强大，那我们就直接用它做DNS服务器就好了，为啥又冒出一个dnsmasq来？

答案是访问速度问题，我们在访问国内网站的时候，没必要劳师动众地把dnscrypt祭出来，因为它的服务器毕竟在国外，域名解析速度比较慢。这时候，我们随便找一个国内的公众DNS服务器就行了，著名的114，阿里，百度，清华，这些都能提供DNS服务，虽然他们返回的国外域名的IP地址肯定是假的，但是对于国内域名，一般来说还是可信的，关键是，他们的访问速度比dnscrypt快得多。

实际上，我们在本机搭建了两个DNS服务器，其最终目的是实现：
- 所有域名，首先都发送到dnsmasq通道，如果是国内域名，dnsmasq调用上层国内DNS服务器（如114，阿里），返回国内域名所对应的IP，达到一个高速解析的效果。

- 如果dnsmasq发现是国外域名，则放弃解析，转交给dnscrypt，通过其加密通道访问其部署在全球的可靠的DNS服务器，返回该域名的真实IP。

----

#### 4、智能识别国内/国外域名

新的问题又来了：dnsmasq 怎么知道哪些域名是国内域名，哪些又是国外域名呢？实际上，说国外域名有点不对，确切地说不能说是全部国外域名，而是“进入GFW黑名单的域名”，为了叙述方便，我们接下来都沿用国外域名这个说法吧。

这就要说到gfwlist这个项目了，这个项目实时更新，将那些被GFW列入黑名单的域名收集起来，导出成一个文件供大家下载。

但 dnsmasq 是不能直接读懂这份文件，于是又有了dnsmasq-gfwlist这个Python写的程序，它的作用就是将原始的gfwlist文件转换为dnsmasq能读懂的格式。好了，现在dnsmasq能知道哪些域名是国内域名，哪些域名是国外域名了，基本实现了智能域名解析的目的，DNS防污染的讲解到此结束。

我们上面讲了一大堆，都是围绕着域名解析在转圈，还没有涉及到流量问题，当我们掏钱向机场购买了梯子后，流量是一个绕不开的问题，首先，机场给我们的流量是有限的，其次，不能所有流量都跑机场去绕一圈，这将严重影响访问速度，所以必须还要面对一个智能分流的问题。

----

#### 5、使用IPSET 对不同的流量进行定向路由

![](https://github.com/rockage/rockage.github.io/blob/master/_posts/images/dns-04.png?raw=true)

这时候ipset登场了，这东东又是干什么的？

ipset是linux系统下路由管理工具iptables的扩展，它允许创建一次匹配整个“地址”集的防火墙规则。这个官方解释挺拗口的，不容易理解，不急，先看dnsmasq的gfwlist文件，里面由几千个这样的内容组成：

**server=/instagram.com/127.0.0.1#30053** 
这一行是关于DNS的，表示将instagram.com这个域名解析任务转交给本机的30053端口去完成，30053其实就是dnscrypt
**ipset=/instagram.com/gfwlist**
这一行与DNS解析无关，而是将instagram.com这个域名解析后的地址放到ipset的gfwlist这张表里去

首先，我们用ipset命令创建了一张表（你也可以理解为一个集合），名字叫gfwlist，请注意，这个表与上面说的那个"gfwlist文件" 同名，但性质完全不同。"gfwlist文件"存放的是国外域名，或者说GFW黑名单，而这里的"gfwlist表"存放的是这些域名所对应的IP地址。

那么，这个IP地址集合又有啥用呢？

我们知道，在Linux系统中，网络流量是可以被分流的（路由），通常使用iptables命令去完成，通过这个命令，我们可以实现定向路由：
- 凡不在gfwlist中的IP，走普通通道

- 凡被收入gfwlist中的IP，走翻墙通道

----

#### 总结

就这么简单，最后再总结一下完整流程：

- 用户输入一个域名

- dnsmasq介入，开始对域名进行解析

- dnsmasq通过gfwlist文件，做两件事：
  - 不在gfwlist中的域名，自己解析，在gfwlist的域名，交给dnscrypt解析
  - 在gfwlist中的域名，将解析后的IP地址，保存在ipset的gfwlist表（集合）中
  - iptables 对流量进行分流（定向路由），凡在gfwlist集合中的流量，走翻墙通道，否则走普通通道。
